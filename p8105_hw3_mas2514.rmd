---
title: "p8105 Homework 3"
author: "Maria Serafini"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(p8105.datasets)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
  )

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
  )

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

__This code chunk loads the p8105 `instacart` data, which is a clean and limited version of The "Instacart Online Grocery Shopping Dataset 2017" and contains information about instacart online grocery orders__

```{r load_p8105_instacart}
data("instacart")
```

The `instacart` data contains `r nrow(instacart)` observations and `r ncol(instacart)` variables and provides information on the instacart grocery orders of `r instacart |> summarize(n = n_distinct(user_id))` users with each row representing a product from an order. The `product_name` variable identifies the product ordered and the `aisle` variable indicates which aisle the ordered item came from. The dataset also includes the variables `add_to_cart_order`, which gives the sequence of products purchased in each order, and `reorder`, which indicates whether that item was ordered by the user in the past. The week and hour of day the order was placed is given by `order_dow` and `order_hour_of_day`, respectively. 

There are a total of `r instacart |> summarize(n = n_distinct(aisle))` aisles and the three aisles with the most items ordered are `r instacart |> group_by(aisle) |> summarize(items_ordered = n()) |> arrange(desc(items_ordered)) |> slice_head(n = 3) |> pull(aisle) |> paste(collapse = ", ")` with `r instacart |> group_by(aisle) |> summarize(items_ordered = n()) |> arrange(desc(items_ordered)) |> slice_head(n = 3) |> pull(items_ordered) |> paste(collapse = ", ")` items ordered for each aisle, respectively.


__This code chunk creates a plot of the number of items ordered per aisle. We group by aisle and count the number of items ordered per aisle, filtering to only include aisles with 10,000 or more items ordered. We then create a plot to visualize the number of items ordered per aisle with the aisles arranged from most to least number of items ordered. We remove the legend for clarity and add labels for readability__

```{r plot_orders_by_aisle}
instacart |> 
  group_by(aisle) |> 
  summarize(
    aisle_items_ordered = n()
  ) |> 
  filter(aisle_items_ordered > 10000) |> 
  ggplot(aes(x = aisle_items_ordered, y = reorder(aisle, aisle_items_ordered), fill = aisle)) +
  geom_col() +
  theme(legend.position = "none") +
  labs(
    x = "Number of Items Ordered", 
    y = "Aisle", 
    title = "Number of Grocery Items Ordered Per Aisle",
    subtitle = "(More than 10,000 Items Ordered)"
  )
```

# 
The table below shows the top 3 most ordered items for the aisles "Baking Ingredients", "Dog Food Care", and "Packages Vegetables Fruits". The top three ordered baking items were "Light Brown Sugar" with 499 orders, "Pure Baking Soda" with 387 orders, and "Cane Sugar" with 336 orders. The top three most ordered dog food items were "Snack Sticks Chicken & Rice Recipe Dog Treats" with 30 orders, "Organix Chicken & Brown Rice Recipe" with 28 orders, and "Small Dog Biscuits" with 26 orders. Finally, the top three items ordered from packaged vegetables and fruits were "Organic Baby Spinach" with 9,784 orders, "Organic Raspberries" with 5,546 orders, and "Organic Blueberries" with 4,966 orders. 

```{r plot_top3_items_by_aisle}
instacart |> 
  filter(aisle %in% c("baking ingredients", "dog food care", "packaged vegetables fruits")) |>
  mutate(
    aisle = case_match(
      aisle,
      "baking ingredients" ~ "Baking Ingrdients",
      "dog food care" ~ "Dog Food Care",
      "packaged vegetables fruits" ~ "Packaged Vegetables Fruits"
    )
  ) |> 
  group_by(aisle, product_name) |> 
  summarize(
    item_count = n(), .groups = "drop_last"
  ) |> 
  arrange(aisle, desc(item_count)) |> 
  slice_head(n = 3) |>
  knitr::kable(
    col.names = c("Aisle", "Product", "Number of Times Ordered")
  )
```

#
The table below shows the mean hour of the day each of the products, Coffee Ice Cream and Pink Lady Apples, were ordered for each day of the week. The earliest mean hour of the day Coffee Ice Cream was ordered was 12.26 on Friday and the latest mean hour was 15.38 on Tuesday. The earliest mean hour of the day Pink Lady Apples were ordered was 11.36 on Monday and the latest was 14.25 on Wednesday. Overall the mean hour of the day Pink lady Apples were ordered was earlier than the mean hour of the day Coffee Ice Cream was ordered for all days except Friday (12.78 vs 12.26, respectively). 

```{r}
instacart |> 
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) |> 
  mutate(
    order_dow = case_match(
      order_dow,
      0 ~ "Sunday",
      1 ~ "Monday",
      2 ~ "Tuesday", 
      3 ~ "Wednesday", 
      4 ~ "Thursday", 
      5 ~ "Friday",
      6 ~ "Saturday"),
    order_dow = factor(
      order_dow,
      levels = c("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"),
      ordered = TRUE)
    ) |> 
  group_by(product_name, order_dow) |> 
  summarize(
    mean_hour_of_day = mean(order_hour_of_day, na.rm = TRUE), .groups = "drop"
  ) |> 
  pivot_wider(
    names_from = order_dow,
    values_from = mean_hour_of_day
  ) |> 
  arrange(product_name) |> 
  rename("Product Name" = product_name) |> 
  knitr::kable(digits = 2)
```


## Problem 2

__This chunk imports and cleans the Zillow NYC rental data and ZIP code data.__

```{r}
nyc_zori_df <-
  read_csv("data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") |> 
  pivot_longer(
    -(RegionID:CountyName),
    names_to = "month",
    values_to = "price") |> 
  janitor::clean_names() |> 
  rename(zip_code = region_name) |> 
  mutate(
    month = as_date(month),
    year = floor_date(month, unit = "year"),
    zip_code = as.numeric(zip_code)) |> 
  select(-county_name)

zip_codes_df <-
  read_csv("data/Zip Codes.csv") |> 
  janitor::clean_names() |> 
  filter(
    !(zip_code == 10463 & county == "New York"),
    !(zip_code == 11201 & county == "New York")) |> 
  mutate(
    borough = case_match(
      county,
      "Bronx" ~ "Bronx",
      "Kings" ~ "Brooklyn",
      "New York" ~ "Manhattan",
      "Queens" ~ "Queens",
      "Richmond" ~ "Staten Island"
    )
  ) |> 
  select(zip_code, borough, neighborhood)

nyc_rental_df = 
  left_join(nyc_zori_df, zip_codes_df, by = "zip_code")
```

There are `r nyc_rental_df |> group_by(zip_code) |> summarize(zipcode_count = sum(!is.na(price)), .groups = "drop") |> filter(zipcode_count == 116) |> nrow()` zip codes observed in all 116 months between January 2015 and August 2024 and  `r nyc_rental_df |> group_by(zip_code) |> summarize(zipcode_count = sum(!is.na(price)), .groups = "drop") |> filter(zipcode_count < 10) |> nrow()` zip codes observed in fewer than 10 of the months. The zip codes that appear in every month, such as 10001 and 10014 are areas of NYC with consistent rental markets (add details) 

#
The table below shows the mean rental price in each borough of NYC by year. 

```{r}
nyc_rental_df |> 
  group_by(borough, year) |> 
  summarize(mean_price = mean(price, na.rm = TRUE), .groups = "drop") |> 
  pivot_wider(
    names_from = borough, 
    values_from = mean_price
  ) |> 
  mutate(year = year(as.Date(year))) |> 
  rename("Year" = year) |> 
  knitr::kable(digits = 0)
```


#
The plot below shows NYC rental prices within each ZIP code by available year and separated by borough. For Manhattan and Brooklyn rental prices were fairly stable until 2021, where there is a noticeable decrease in rental prices before a steady increase through 2024. This noticable dip represents the decrease in rental prices following the COVID-19 pandemic as residents moved out of the city and the demand for commercial/office rental space decreased.  

```{r}
nyc_rental_df |> 
  select(zip_code, price, month, year, borough) |> 
  mutate(
    zip_code = as.factor(zip_code)
  ) |> 
  drop_na() |> 
  ggplot(aes(x = month, y = price, group = zip_code, color = zip_code)) +
  geom_line(alpha = 0.5, linewidth = 0.4) +
  #geom_smooth(aes(group = borough), se = FALSE) +
  theme(legend.position = "none") +
  facet_wrap(~borough, ncol = 2) +
  labs(
    title = "Rental Prices Within NYC Zip Codes by Year and Borough",
    x = "Year",
    y = "Rental Price (Dollars)")
```
